<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeu de Morpion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            min-height: 100vh;
        }
        
        .cell {
            transition: all 0.3s ease;
        }
        
        .cell:hover:not(.filled) {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .x-mark, .o-mark {
            transform: scale(0);
            transition: transform 0.3s ease;
        }
        
        .x-mark.show, .o-mark.show {
            transform: scale(1);
        }
        
        .winner-line {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 10;
            transform-origin: center;
            transition: transform 0.5s ease;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
            animation: confetti-fall 3s ease-in-out forwards;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(calc(100vh + 100px)) rotate(720deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4">
    <div class="bg-white bg-opacity-90 rounded-xl shadow-xl p-6 max-w-md w-full">
        <h1 class="text-3xl font-bold text-center text-indigo-700 mb-2">Morpion</h1>
        <p class="text-center text-gray-600 mb-6">Jouez contre l'ordinateur</p>
        
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center">
                <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white font-bold mr-2">X</div>
                <span class="font-medium">Vous</span>
            </div>
            <div id="status" class="px-4 py-1 rounded-full bg-indigo-100 text-indigo-800 font-medium">
                À votre tour
            </div>
            <div class="flex items-center">
                <span class="font-medium mr-2">Ordinateur</span>
                <div class="w-8 h-8 rounded-full bg-pink-500 flex items-center justify-center text-white font-bold">O</div>
            </div>
        </div>
        
        <div id="board" class="relative bg-indigo-50 rounded-lg overflow-hidden mb-6">
            <div class="grid grid-cols-3 gap-2 p-2">
                <div class="cell aspect-square bg-white rounded-lg shadow-sm flex items-center justify-center" data-index="0"></div>
                <div class="cell aspect-square bg-white rounded-lg shadow-sm flex items-center justify-center" data-index="1"></div>
                <div class="cell aspect-square bg-white rounded-lg shadow-sm flex items-center justify-center" data-index="2"></div>
                <div class="cell aspect-square bg-white rounded-lg shadow-sm flex items-center justify-center" data-index="3"></div>
                <div class="cell aspect-square bg-white rounded-lg shadow-sm flex items-center justify-center" data-index="4"></div>
                <div class="cell aspect-square bg-white rounded-lg shadow-sm flex items-center justify-center" data-index="5"></div>
                <div class="cell aspect-square bg-white rounded-lg shadow-sm flex items-center justify-center" data-index="6"></div>
                <div class="cell aspect-square bg-white rounded-lg shadow-sm flex items-center justify-center" data-index="7"></div>
                <div class="cell aspect-square bg-white rounded-lg shadow-sm flex items-center justify-center" data-index="8"></div>
            </div>
            <div id="winner-line" class="winner-line hidden"></div>
        </div>
        
        <div class="flex justify-between items-center">
            <div class="text-gray-700">
                <span class="font-medium">Score:</span>
                <span id="player-score" class="ml-1 text-indigo-600 font-bold">0</span>
                <span class="mx-1">-</span>
                <span id="computer-score" class="text-pink-500 font-bold">0</span>
            </div>
            <button id="reset-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                Nouvelle partie
            </button>
        </div>
        <div class="w-full flex justify-center mt-4">
    <button id="back-to-quiz-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-lg">
        Retour au Menu Quiz
    </button>
</div>
    </div>
    
    <div id="confetti-container" class="fixed inset-0 pointer-events-none"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cells = document.querySelectorAll('.cell');
            const statusEl = document.getElementById('status');
            const resetBtn = document.getElementById('reset-btn');
            const playerScoreEl = document.getElementById('player-score');
            const computerScoreEl = document.getElementById('computer-score');
            const winnerLine = document.getElementById('winner-line');
            const confettiContainer = document.getElementById('confetti-container');
            
            let board = ['', '', '', '', '', '', '', '', ''];
            let currentPlayer = 'X';
            let gameActive = true;
            let playerScore = 0;
            let computerScore = 0;
            
            const winPatterns = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // lignes
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // colonnes
                [0, 4, 8], [2, 4, 6]             // diagonales
            ];
            
            // Initialiser le jeu
            initGame();
            
            function initGame() {
                board = ['', '', '', '', '', '', '', '', ''];
                currentPlayer = 'X';
                gameActive = true;
                statusEl.textContent = 'À votre tour';
                statusEl.className = 'px-4 py-1 rounded-full bg-indigo-100 text-indigo-800 font-medium';
                winnerLine.classList.add('hidden');
                
                cells.forEach(cell => {
                    cell.innerHTML = `
                        <div class="x-mark text-indigo-600 w-full h-full flex items-center justify-center">
                            <svg class="w-2/3 h-2/3" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="o-mark text-pink-500 w-full h-full flex items-center justify-center">
                            <svg class="w-2/3 h-2/3" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="3" fill="none"/>
                            </svg>
                        </div>
                    `;
                    
                    const xMark = cell.querySelector('.x-mark');
                    const oMark = cell.querySelector('.o-mark');
                    xMark.classList.remove('show');
                    oMark.classList.remove('show');
                    
                    cell.classList.remove('filled');
                });
            }
            
            function handleCellClick(e) {
                const cell = e.target.closest('.cell');
                if (!cell || !gameActive) return;
                
                const index = cell.dataset.index;
                
                if (board[index] !== '') return;
                
                // Coup du joueur
                makeMove(index, 'X');
                
                // Vérifier si le jeu est terminé après le coup du joueur
                if (gameActive) {
                    // Coup de l'ordinateur après un court délai
                    statusEl.textContent = "L'ordinateur réfléchit...";
                    setTimeout(() => {
                        computerMove();
                    }, 600);
                }
            }
            
            function makeMove(index, player) {
                board[index] = player;
                const cell = document.querySelector(`.cell[data-index="${index}"]`);
                
                // Afficher la marque appropriée
                const xMark = cell.querySelector('.x-mark');
                const oMark = cell.querySelector('.o-mark');
                
                if (player === 'X') {
                    xMark.classList.add('show');
                } else {
                    oMark.classList.add('show');
                }
                
                cell.classList.add('filled');
                
                // Vérifier s'il y a une victoire ou un match nul
                const result = checkGameResult();
                
                if (result.state === 'win') {
                    gameActive = false;
                    if (result.winner === 'X') {
                        playerScore++;
                        playerScoreEl.textContent = playerScore;
                        statusEl.textContent = 'Vous avez gagné!';
                        statusEl.className = 'px-4 py-1 rounded-full bg-green-100 text-green-800 font-medium';
                        createConfetti();
                    } else {
                        computerScore++;
                        computerScoreEl.textContent = computerScore;
                        statusEl.textContent = "L'ordinateur a gagné!";
                        statusEl.className = 'px-4 py-1 rounded-full bg-pink-100 text-pink-800 font-medium';
                    }
                    
                    // Dessiner la ligne gagnante
                    drawWinnerLine(result.pattern);
                    
                } else if (result.state === 'draw') {
                    gameActive = false;
                    statusEl.textContent = 'Match nul!';
                    statusEl.className = 'px-4 py-1 rounded-full bg-gray-100 text-gray-800 font-medium';
                } else {
                    // Changer de joueur
                    currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
                    if (currentPlayer === 'X') {
                        statusEl.textContent = 'À votre tour';
                    }
                }
            }
            
            function computerMove() {
                if (!gameActive) return;
                
                // Trouver le meilleur coup avec un algorithme simple
                let bestScore = -Infinity;
                let bestMove;
                
                // D'abord vérifier si l'ordinateur peut gagner
                for (let i = 0; i < board.length; i++) {
                    if (board[i] === '') {
                        board[i] = 'O';
                        if (checkWin('O')) {
                            bestMove = i;
                            board[i] = '';
                            break;
                        }
                        board[i] = '';
                    }
                }
                
                // Si pas de coup gagnant, vérifier si le joueur peut gagner et bloquer
                if (bestMove === undefined) {
                    for (let i = 0; i < board.length; i++) {
                        if (board[i] === '') {
                            board[i] = 'X';
                            if (checkWin('X')) {
                                bestMove = i;
                                board[i] = '';
                                break;
                            }
                            board[i] = '';
                        }
                    }
                }
                
                // Si pas besoin de bloquer, essayer le centre
                if (bestMove === undefined && board[4] === '') {
                    bestMove = 4;
                }
                
                // Si le centre est pris, choisir une case disponible au hasard
                if (bestMove === undefined) {
                    const availableMoves = board.map((cell, index) => cell === '' ? index : null).filter(cell => cell !== null);
                    if (availableMoves.length > 0) {
                        bestMove = availableMoves[Math.floor(Math.random() * availableMoves.length)];
                    }
                }
                
                // Faire le coup
                if (bestMove !== undefined) {
                    makeMove(bestMove, 'O');
                }
            }
            
            function checkWin(player) {
                return winPatterns.some(pattern => {
                    return pattern.every(index => board[index] === player);
                });
            }
            
            function checkGameResult() {
                // Vérifier s'il y a une victoire
                for (const pattern of winPatterns) {
                    const [a, b, c] = pattern;
                    if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                        return {
                            state: 'win',
                            winner: board[a],
                            pattern: pattern
                        };
                    }
                }
                
                // Vérifier s'il y a un match nul
                if (!board.includes('')) {
                    return { state: 'draw' };
                }
                
                // Le jeu continue
                return { state: 'ongoing' };
            }
            
            function drawWinnerLine(pattern) {
                const boardEl = document.getElementById('board');
                const boardRect = boardEl.getBoundingClientRect();
                const cellWidth = boardRect.width / 3;
                const cellHeight = boardRect.height / 3;
                
                const [a, b, c] = pattern;
                
                // Calculer les positions en fonction du motif
                let x1, y1, x2, y2, width, height, angle;
                
                // Victoire horizontale
                if (Math.floor(a / 3) === Math.floor(b / 3) && Math.floor(b / 3) === Math.floor(c / 3)) {
                    const row = Math.floor(a / 3);
                    y1 = y2 = (row + 0.5) * cellHeight;
                    x1 = cellWidth * 0.1;
                    x2 = boardRect.width - cellWidth * 0.1;
                    width = x2 - x1;
                    height = 6;
                    angle = 0;
                }
                // Victoire verticale
                else if (a % 3 === b % 3 && b % 3 === c % 3) {
                    const col = a % 3;
                    x1 = x2 = (col + 0.5) * cellWidth;
                    y1 = cellHeight * 0.1;
                    y2 = boardRect.height - cellHeight * 0.1;
                    width = 6;
                    height = y2 - y1;
                    angle = 90;
                }
                // Victoire diagonale (haut-gauche à bas-droite)
                else if (pattern.toString() === [0, 4, 8].toString()) {
                    x1 = y1 = cellWidth * 0.1;
                    x2 = y2 = boardRect.width - cellWidth * 0.1;
                    width = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                    height = 6;
                    angle = 45;
                }
                // Victoire diagonale (haut-droite à bas-gauche)
                else if (pattern.toString() === [2, 4, 6].toString()) {
                    x1 = boardRect.width - cellWidth * 0.1;
                    y1 = cellHeight * 0.1;
                    x2 = cellWidth * 0.1;
                    y2 = boardRect.height - cellHeight * 0.1;
                    width = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                    height = 6;
                    angle = -45;
                }
                
                winnerLine.style.width = `${width}px`;
                winnerLine.style.height = `${height}px`;
                winnerLine.style.left = `${(x1 + x2) / 2 - width / 2}px`;
                winnerLine.style.top = `${(y1 + y2) / 2 - height / 2}px`;
                winnerLine.style.transform = `rotate(${angle}deg) scaleX(0)`;
                winnerLine.classList.remove('hidden');
                
                // Animer la ligne
                setTimeout(() => {
                    winnerLine.style.transform = `rotate(${angle}deg) scaleX(1)`;
                }, 50);
            }
            
            function createConfetti() {
                const colors = ['#FFC700', '#FF0055', '#2BD1FC', '#F3A712', '#F2055C'];
                
                for (let i = 0; i < 100; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.left = `${Math.random() * 100}%`;
                    confetti.style.animationDelay = `${Math.random() * 3}s`;
                    confetti.style.animationDuration = `${3 + Math.random() * 2}s`;
                    
                    confettiContainer.appendChild(confetti);
                    
                    // Supprimer les confettis après l'animation
                    setTimeout(() => {
                        confetti.remove();
                    }, 5000);
                }
            }
            
            const backToQuizButton = document.getElementById('back-to-quiz-btn');
            if (backToQuizButton) {
                backToQuizButton.addEventListener('click', () => {
                    // S'assurer que le jeu est bien dans une iframe avant d'envoyer le message
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage('closeGameIframe', '*');
                        // Le '*' est pour targetOrigin. Pour plus de sécurité en production,
                        // remplacez-le par l'origine de quizzadventure.html
                        // Par exemple: window.parent.postMessage('closeGameIframe', 'http://localhost:xxxx');
                        // ou window.parent.postMessage('closeGameIframe', window.location.ancestorOrigins[0]); si applicable
                    } else {
                        // Optionnel: comportement si le jeu n'est pas dans une iframe (ex: redirection)
                        // window.location.href = 'quizzadventure.html'; // Moins idéal
                        console.warn("Ce jeu n'est pas dans une iframe ou ne peut pas communiquer avec le parent.");
                    }
                });
            }
            // Écouteurs d'événements
            cells.forEach(cell => {
                cell.addEventListener('click', handleCellClick);
            });
            
            resetBtn.addEventListener('click', initGame);
        });
    </script>
</body>
</html>
